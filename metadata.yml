title: Actions Datasette Dashboards Demo
about: eroullit/actions-datasette-dashboards
about_url: https://github.com/eroullit/actions-datasette-dashboards
description_html: |-
  <div class="message-info">
    <p>Welcome to the <a href="https://github.com/eroullit/actions-datasette-dashboards">Actions-Datasette-Dashboards</a> Actions Datasette Dashboard!</p>
    <ul class="bullets">
      <li>Browse dashboards at <a href="/-/dashboards">/-/dashboards</a></li>
      <li>See an example of an embedded dashboard within a custom page at <a href="/embedded_dashboard">/embedded_dashboard</a></li>
      <li>See an example of an embedded chart within a custom page at <a href="/embedded_chart">/embedded_chart</a></li>
    </ul>
  </div>

plugins:
  datasette-sqlite-http:
    UNSAFE_allow_http_requests: true

  datasette-dashboards:
    usage-stats:
      title: Actions usage statistics
      description: Gather metrics about Actions usage from the Usage Report
      settings:
        allow_fullscreen: true
        autorefresh: false
      layout:
        - [actions-minutes-monthly-tracker, actions-minutes-daily-tracker]
        - [runner-types-ranking, actions-run-daily]
        - [actions-duration-ranking, actions-duration-ranking]
        - [actions-duration-scatterplot, actions-duration-scatterplot]
        - [actions-price-ranking, actions-price-ranking]
      filters:
        date_start:
          name: Date Start
          type: date
        date_end:
          name: Date End
          type: date
        owner:
          name: Organisation
          type: select
          db: usage
          query: SELECT DISTINCT owner FROM usage ORDER BY owner
      charts:
        actions-run-daily:
          title: Daily executed workflow count
          db: usage
          query: >-
            SELECT
              date(date) as date,
              count(*) as count
            FROM usage
            WHERE Product = 'Actions'
              [[ AND date >= date(:date_start) ]]
              [[ AND date <= date(:date_end) ]]
              [[ AND owner = :owner ]]
              GROUP BY date
          library: vega-lite
          display:
            mark: { type: line, tooltip: true }
            encoding:
              x: { field: date, type: temporal, timeUnit: yearmonthdate }
              y: { field: count, type: quantitative }

        actions-minutes-daily-tracker:
          title: Daily minutes usage tracker
          db: usage
          query: >-
            SELECT
              date(date) as date,
              SKU,
              SUM(quantity * multiplier) as TotalQuantity
            FROM usage
            WHERE Product = 'Actions'
              [[ AND date >= date(:date_start) ]]
              [[ AND date <= date(:date_end) ]]
              [[ AND owner = :owner ]]
            GROUP BY date, SKU
          library: vega-lite
          display:
            mark: { type: bar, tooltip: true }
            params:
              - name: highlight
                select: { fields: [SKU], type: point, "on": mouseover }
                bind: legend
            encoding:
              x: { field: date, type: temporal, timeUnit: yearmonthdate }
              y: { field: TotalQuantity, type: quantitative }
              color: { field: SKU, type: nominal }
              opacity:
                condition: { param: highlight, value: 1 }
                value: 0.2

        actions-minutes-monthly-tracker:
          title: Monthly minutes usage tracker
          db: usage
          query: >-
            SELECT
              date(date) as date,
              SKU,
              SUM(quantity * multiplier) as TotalQuantity
            FROM usage
            WHERE Product = 'Actions'
              [[ AND date >= date(:date_start) ]]
              [[ AND date <= date(:date_end) ]]
              [[ AND owner = :owner ]]
            GROUP BY date, SKU
          library: vega-lite
          display:
            mark: { type: bar, tooltip: true }
            params:
              - name: highlight
                select: { fields: [SKU], type: point, "on": mouseover }
                bind: legend
            encoding:
              x: { aggregate: sum, field: TotalQuantity, type: quantitative }
              y: { field: date, type: ordinal, timeUnit: month, as: month}
              color: { field: SKU, type: nominal }
              opacity:
                condition: { param: highlight, value: 1 }
                value: 0.2

        runner-types-ranking:
          title: Number of runs by runner types
          db: usage 
          query: >-
            SELECT
              SKU,
              count(*) as count
            FROM usage
            WHERE Product = 'Actions'
              [[ AND date >= date(:date_start) ]]
              [[ AND date <= date(:date_end) ]]
              [[ AND owner = :owner ]]
            GROUP BY SKU
            ORDER BY count DESC
          library: vega-lite
          display:
            mark: { type: arc, tooltip: true }
            params:
              - name: highlight
                select: { fields: [SKU], type: point, "on": mouseover }
                bind: legend
            encoding:
              color: { field: SKU, type: nominal }
              theta: { field: count, type: quantitative }
              opacity:
                condition: { param: highlight, value: 1 }
                value: 0.2

        actions-duration-ranking:
          title: actions duration ranking
          db: usage
          query: >-
            SELECT
              CAST(quantity as INTEGER) as quantity,
              SKU,
              COUNT(*) as count
            FROM usage
            WHERE Product = 'Actions'
              [[ AND date >= date(:date_start) ]]
              [[ AND date <= date(:date_end) ]]
              [[ AND owner = :owner ]]
            GROUP BY quantity, SKU
            ORDER BY quantity
          library: vega-lite
          display:
            mark: { type: bar, tooltip: true }
            params:
              - name: highlight
                select: { fields: [SKU], type: point, "on": mouseover }
                bind: legend
            encoding:
              y: { field: quantity, bin: {extent: [0, 45]}, type: ordinal }
              x: { aggregate: sum, field: count}
              color: { field: SKU, type: nominal }
              opacity:
                condition: { param: highlight, value: 1 }
                value: 0.2

        actions-duration-scatterplot:
          title: Workflow duration
          db: usage
          query: >-
            SELECT
              date(date) as date,
              CAST(quantity as INTEGER) as quantity,
              SKU,
              Owner,
              "Repository Slug",
              "Actions Workflow"
            FROM usage
            WHERE Product = 'Actions'
              [[ AND date >= date(:date_start) ]]
              [[ AND date <= date(:date_end) ]]
              [[ AND owner = :owner ]]
          library: vega-lite
          display:
            mark: { type: point, tooltip: {content: data} }
            params:
              - name: highlight
                select: { fields: [SKU], type: point, "on": mouseover }
                bind: legend
            encoding:
              x: { field: date, type: ordinal, timeUnit: yearmonthdate }
              y: { field: quantity, type: quantitative }
              color: { field: SKU, type: nominal }
              opacity:
                condition: { param: highlight, value: 1 }
                value: 0.2

        actions-price-ranking:
          title: Actions price heatmap
          db: usage
          query: >-
            SELECT
              CAST(quantity as INTEGER) as quantity,
              price
            FROM usage
            WHERE Product = 'Actions'
              [[ AND date >= date(:date_start) ]]
              [[ AND date <= date(:date_end) ]]
              [[ AND owner = :owner ]]
            GROUP BY quantity, price
          library: vega-lite
          display:
            mark: rect
            encoding:
              x: { field: quantity, bin: {maxbins: 100}, type: quantitative }
              y: { field: price, bin: {maxbins: 50}, type: quantitative}
              color: { aggregate: count, type: quantitative }
